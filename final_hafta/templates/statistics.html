{% extends "base.html" %}
{% block page_class %}dashboard-background{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-white mb-4 text-center">📊 Ziyaretçi İstatistikleri</h2>

  <!-- 📅 Mes Seçimi -->
  <div class="text-white text-center">
    <h4>📅 Geçmiş Ayları Görüntüle</h4>
    <form method="GET" action="{{ url_for('statistics') }}">
      <input type="month" name="month" value="{{ selected_month }}" class="form-control d-inline-block w-auto">
      <button type="submit" class="btn btn-primary mt-2">Filtrele</button>
    </form>
  </div>

  <div class="row text-center mt-4">
    <div class="col-md-3">
      <div class="card shadow-sm p-3 mb-3">
        <h5>👤 Bugün</h5>
        <p class="fs-4">{{ total_today }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3 mb-3">
        <h5>📅 Bu Hafta</h5>
        <p class="fs-4">{{ total_week }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3 mb-3">
        <h5>🗓️ Bu Ay</h5>
        <p class="fs-4">{{ total_month }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3 mb-3">
        <h5>📅 Seçilen Ay</h5>
        <p class="fs-4">{{ total_selected_month }}</p>
      </div>
    </div>
  </div>

  <!-- 👥 En sık gelen ziyaretçiler -->
  <div class="text-white mt-5">
    <h4>👥 En Sık Gelen Ziyaretçiler</h4>
    {% if top_visitors %}
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>👤 Adı ve Soyadı</th>
          <th>📞 Telefon</th>
          <th>🔁 Ziyaret Sayısı</th>
        </tr>
      </thead>
      <tbody>
        {% for name, surname, phone, total in top_visitors %}
        <tr>
          <td>{{ name }} {{ surname }}</td>
          <td>{{ phone }}</td>
          <td>{{ total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="text-muted">Yeterli veri yok.</p>
    {% endif %}
  </div>

<!-- 📊 Ziyaretlerin aya göre dağılımı -->
<div class="text-white mt-5">
  <h4>📈 Ziyaretçi Trendleri (Aylık)</h4>
  {% if visits_by_month %}
  <canvas id="monthlyVisitsChart" height="100"></canvas>
  {% else %}
    <p class="text-muted">Grafik için veri yok.</p>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const months = JSON.parse('{{ visits_by_month | map(attribute=0) | list | tojson | safe }}');
  const monthlyData = JSON.parse('{{ visits_by_month | map(attribute=1) | list | tojson | safe }}');

  const ctx = document.getElementById('monthlyVisitsChart').getContext('2d');
  const monthlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Aylık Ziyaretler',
        data: monthlyData,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Ziyaret Sayısı'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Aylar'
          }
        }
      }
    }
  });
</script>
{% endblock %}